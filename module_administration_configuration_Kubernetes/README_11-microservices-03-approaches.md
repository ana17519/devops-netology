**Домашнее задание к занятию «Микросервисы: подходы»**

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

**Задача 1: Обеспечить разработку**

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* облачная система;
* система контроля версий Git;
* репозиторий на каждый сервис;
* запуск сборки по событию из системы контроля версий;
* запуск сборки по кнопке с указанием параметров;
* возможность привязать настройки к каждой сборке;
* возможность создания шаблонов для различных конфигураций сборок;
* возможность безопасного хранения секретных данных (пароли, ключи доступа);
* несколько конфигураций для сборки из одного репозитория;
* кастомные шаги при сборке;
* собственные докер-образы для сборки проектов;
* возможность развернуть агентов сборки на собственных серверах;
* возможность параллельного запуска нескольких сборок;
* возможность параллельного запуска тестов.

Обоснуйте свой выбор.

| Таблицы       |             Gitlab CI/CD  + Gitlab-хранение кода              |                       Jenkins  CI/CD + Gitlab-хранение кода                        |                                         TeamCity CI/CD / BitBucket-хранение кода                                          |
| ------------- |:-----------------------------------------:|:----------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------:|
| облачная система                                         | + предлагает размещение проектов в облаке |                   можно настроить Jenkins-мастер в облаке                    |                                                             +                                                             |  
| система контроля версий Git                              |                     +                     |                                      +                                       |                                                             +                                                             |   
| запуск сборки по событию из системы контроля версий      |                     +                     |                                      +                                       |                                                             +                                                             |   
| репозиторий на каждый сервис                            |                     +                     |                                      +                                       |                                                             +                                                             |   
| запуск сборки по кнопке с указанием параметров           |     - параметры в yaml можно добавить     |                                      +                                       |                                                             +                                                             |    
| возможность привязать настройки к каждой сборке          |                     +                     |                                      +                                       |                                                             +                                                             |    
|возможность создания шаблонов для различных конфигураций сборок         |                     +                     |                          есть шаблоны по умолчанию                           |                                                             +                                                             |    
|возможность безопасного хранения секретных данных (пароли, ключи доступа)|                     +                     |                                      +                                       |                                                             +                                                             |   
|несколько конфигураций для сборки из одного репозитория                 |                     +                     |                                      +                                       |                                                             +                                                             |    
|кастомные шаги при сборке                                               |     можно указать выполнение скрипта      |                                      +                                       |                                                             +                                                             |    
| собственные докер-образы для сборки проектов                 |                     +                     | Jenkins агенты умеют работать с такими Docker образами, но помойму своиз нет |                    Используя билд-раннер Docker, можно добавить к сборке шаги выполнения команд Docker                    |   
| возможность развернуть агентов сборки на собственных серверах |                     +                     |                                      +                                       |                                                             +                                                             |    
| возможность параллельного запуска нескольких сборок          |                     +                     |                                      +                                       |                                               + (зависит от кол-ва агентов)                                               |    
| возможность параллельного запуска тестов                     |                     +                     |                                      +                                       |                                                             +                                                             | 

В компании, где сейчас работаю, выбрано TeamCity для CI/CD + BitBucket-хранение кода
Для меня TeamCity неудобен отсутствием прав администратора, чтобы настроить запуск тестов (отдельный проект) после прохождения сборки проекта.

Ранее работала со связкой Jenkins - запуск автотестов (были права админа, настраивала джобы под себя) + Gitlab - хранение кода + пайплайны для выкаток разработчиков

Gitlab CI/CD - часть функционала не бесплатна, у Jenkins есть много плагинов для работы, Temcity - коммерческий продукт, предпочла бы первый или второй вариант.

**Задача 2: Логи**

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* сбор логов в центральное хранилище со всех хостов, обслуживающих систему;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
* минимальные требования к приложениям, сбор логов из stdout;
* гарантированная доставка логов до центрального хранилища;
* обеспечение поиска и фильтрации по записям логов;
* обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
* возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.
                            
|        |                                                                        ELK: Elasticsearch, Logstash и Kibana                                                                         | EFK (Elasticsearch + Fluentd + Kibana)  | Grafana(Promatail + Loki +Grafana) |       Graylog Open |
| ------------- |:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------:|:----------------------------------:|:------------------------:|
| сбор логов в центральное хранилище со всех хостов, обслуживающих систему;  |                                                                                          +                                                                                           |           +             |      +                               |  +|                  
| минимальные требования к приложениям, сбор логов из stdout;                |                                                                                          +                                                                                           |      +                 |       +                              |  +|
| гарантированная доставка логов до центрального хранилища;                  |                     Logstash направляет все данные в один поток, а затем использует алгоритмические операторы if-then для отправки их в нужное место назначения                      |       Fluentd использует теги для маршрутизации событий. У каждого события Fluentd есть тег, который сообщает Fluentd, куда оно должно быть направлено               |                                +     |  +|
| обеспечение поиска и фильтрации по записям логов;                                                                          |                                                                                          +                                                                                           |           +            |                                +     |   +    |
| обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;  |                                                                                          +                                                                                           |           +            |                                +     |     +  |
| возможность дать ссылку на сохранённый поиск по записям логов.                                                             |                                                                                          +                                                                                           |           +            |   невозможен полнотекстовый поиск по индексу, в нём данные ищутся сначала по индексированным полям, а затем текст выбранных логов сканируется регулярными выражениями                                |   Graylog можно создавать и объединять несколько поисковых запросов в одно действие и просматривать полученные результаты на экране, похожем на дашборд, причём эти комбинированные запросы можно сохранять   |
                                                                                                                                                                                                   
  Использовала бы ELK / EFK (Logstash потребляет больше памяти, чем Fluentd)

ELK-стек является самым полнофункциональным решением по сбору и обработке данных, однако, алертинг есть только в платных версиях. 
Graylog также является средством больше для анализа логов. Grafana Loki является самым простым и легковесным решением и он подходит для 
решения узких задач, когда не нужна полноценная наблюдаемость (observability) систем и сервисов.

В компании, где сейчас работаю, используется ELK.

**Задача 3: Мониторинг**    

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

* сбор метрик со всех хостов, обслуживающих систему;
* сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
* сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
* сбор метрик, специфичных для каждого сервиса;
* пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
* пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.         

Обоснуйте свой выбор.


|        | Prometheus+Grafana | Grafana+Zabbix |TICK ( telegraf, influxdb, chronograf, kapacitor) + Grafana|
| ------------- |:------------------:|:-----:|:-----:|
|сбор метрик со всех хостов, обслуживающих систему;                               |         +          | + |+|
|сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;                   |         +          |  +|+|
|сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;   |         +          |   + |+|
|сбор метрик, специфичных для каждого сервиса;                                                                |         +          | + | + |
|пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;                          |         +          |   +| + |
|пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.   |         +          |   + |+ | 

Выбрала бы Prometheus+Grafana, поскольку не нужна отдельная база для хранения в отличие от Zabbix