**Домашнее задание к занятию «Микросервисы: принципы»**

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры. 
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

**Задача 1: API Gateway**

Предложите решение для обеспечения реализации API Gateway. 
Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

**Решение должно соответствовать следующим требованиям:**

1. маршрутизация запросов к нужному сервису на основе конфигурации,
2. возможность проверки аутентификационной информации в запросах,
3. обеспечение терминации HTTPS.
 
Обоснуйте свой выбор.

API Gateway выполняет множество задач: принимает, обрабатывает и распределяет запросы, контролирует трафик, 
осуществляет мониторинг и контроль доступа. 

В микросервисной архитектуре паттерн API Gateway появился в качестве службы, обеспечивающей единую 
точку входа для веб-приложений и API, эдакой «серверной части для клиентской части». 


|      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Azure API Management |Amazon API Gateway |Oracle API Gateway |Google API Gateway|                                                                                                                                                                                                                                                  Yandex API Gateway |                                                                                                                                                                                  SberCloud API Gateway |
| ------------- |:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:| -----:| -----:| -----:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| маршрутизация запросов к нужному сервису на основе конфигурации     |                                                                                                                                                                                                                                                                                          Шлюзы API обеспечивают согласованную настройку безопасности, маршрутизации, регулирования, наблюдения и кэширования. Все запросы от клиентского приложения сначала достигают шлюза API, а затем перенаправляются в соответствующие серверные службы. Шлюз API Azure действует как внешний интерфейс для серверных служб, где поставщики API могут абстрагировать реализации API и разрабатывать серверные архитектуры, не затрагивая потребителей API. |API Gateway позволяет для каждой части адреса конечной точки API настроить отдельную обработку. Благодаря этому можно маршрутизировать запросы API в отдельные конечные точки бэкэнда, а также одновременно с этим изменять заголовки в запросе/ответе для более гибкой обработки API-запросов.|Шлюз API предлагает ряд различных фильтров, которые можно использовать для маршрутизации сообщений. В зависимости от того, как шлюз API воспринимается клиентом, могут использоваться различные комбинации фильтров маршрутизации. |Шлюз API сопоставляет путь входящих запросов с целевым API. Найдя соответствующий маршрут, API Gateway выполняет любые шаги аутентификации для указанного API. |                                                                                                                                                                                                                                                               набор расширений для интеграции с другими облачными сервисами |                                                                                                                                                 Можно создать правила с типом «Маршрутизация запросов» |
| возможность проверки аутентификационной информации в запросах     |    Управление API Azure опирается на Azure Active Directory (Azure AD), который включает в себя дополнительные функции, такие как многофакторная проверка подлинности (MFA) и Azure RBAC, чтобы обеспечить детальный доступ к службе управления API и ее сущностям, включая API и политики.                                                                                                                                                                                                                                                                                                                                                                                                                                                | Amazon API Gateway позволяет дополнительно указать методы API, которые будут требовать авторизации. Установив требование авторизации для метода, можно использовать AWS Signature Version 4 или средства авторизации Lambda для поддержки выбранной стратегии авторизации токенов на предъявителя. |Каждая служба в облачной инфраструктуре Oracle интегрируется с IAM для аутентификации и авторизации (консоль, SDK или CLI и REST API).С помощью Policy Studio к шлюзу API добавляются политики безопасности и управления, а также есть возможность управления версиями политик на нескольких шлюзах API — централизованно, а не отдельно на каждом шлюзе API. API Gateway может аутентифицировать внешних клиентов по имени пользователя и паролю, а затем выдавать токены SAML. |доступ к API с помощью AWS Identity and Access Management (IAM) и Amazon Cognito. Используя токены OAuth, вы задействуете встроенную поддержку OIDC и OAuth2 API Gateway. Для поддержки настраиваемых требований авторизации вы можете запустить средство авторизации Lambda из AWS Lambda. |                                                                                 позволяет реализовать стандартные механизмы аутентификации и авторизации, которые предусмотрены спецификацией OpenAPI 3.0. На данный момент доступна авторизация с помощью функции. |   Simple Authentication (только для режима аутентификации App) — AppCode используется для проведения простой процедуры аутентификации. Клиенты, вызывающие API, добавляют AppCode в заголовок запроса. |
| обеспечение терминации HTTPS  |      Современные протоколы безопасности API, такие как OAuth2 и Open ID Connect, предполагают, что весь HTTP-трафик в сети шифруется с использованием TLS. Поэтому хорошей практикой безопасности является принудительное использование HTTPS в управлении API. В Azure механизм политик Azure предназначен для того, чтобы взять на себя эту ответственность.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  | |Нужно установить для балансировщика нагрузки сертификат Secure Sockets Layer (SSL). Балансировщик нагрузки использует этот сертификат для терминации подключения, а затем дешифрует запросы от клиентов перед отправкой целевым объектам.|                                                                                                                    Обработка запросов только по протоколу HTTPS. Сервис автоматически перенаправляет все запросы к API-шлюзам по протоколу HTTP на их HTTPS-версии. |                                                                                                                                     API Gateway поддерживает только одностороннюю проверку подлинности |

C учетом текущей ситуации выбор думаю состоит между SberCloud API Gateway и Yandex API Gateway. На основе вышеописанного видится, что Yandex API Gateway соответствует вышеуказанным требованиям


**Задача 2: Брокер сообщений**

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:

1. поддержка кластеризации для обеспечения надёжности,
2. хранение сообщений на диске в процессе доставки,
3. высокая скорость работы,
4. поддержка различных форматов сообщений,
5. разделение прав доступа к различным потокам сообщений,
6. простота эксплуатации.

Обоснуйте свой выбор.


|        |                                                                          RabbitMQ                                                                           |                                                                                                                                                   Apache Kafka                                                                                                                                                    |                                                                                   Amazon Simple Queue Service (SQS)                                                                                   |
| ------------- |:-----------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| поддержка кластеризации для обеспечения надёжности   |                                                                              +                                                                              |                                                                                                                                                         +                                                                                                                                                         |                                                                                                   -                                                                                                   |
| хранение сообщений на диске в процессе доставки  |                                поддерживает сохранение сообщений на диск,  все сообщения после чтения из очереди удаляются.                                 |                                                          Время, в течение которого Kafka хранит старые сообщения может быть настроено при помощи свойств.По умолчанию срок хранения – 1 час.  В Kafka данные физически хранятся на диске в виде партиций                                                          |Если система, отвечающая за обработку, успешно завершает работу с сообщением, она вызывает запрос DeleteMessage, который удаляет сообщение из очереди, чтобы никакой другой компьютер не мог обработать его. Если системе не удастся обработать сообщение, оно будет прочитано в ходе другого запроса ReceiveMessage, когда истечет тайм-аут видимости.|
| высокая скорость работы |                                      RabbitMQ позволяет обрабатывать порядка 20000 сообщений в секунду на одну машину                                       |                       В зависимости от размера batch Apache Kafka имеет разную пропускную способность. При размере batch = 10, Kafka имеет пропускную способность порядка 35 000 сообщений в секунду, а при batch =100 достигается пропускная способность в 89000 в секунду на одну машину.                       |                                                                                        300 сообщений в секунду                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         $12 |$1600 |$1600 |                                                                                                                    Обработка запросов только по протоколу HTTPS. Сервис автоматически перенаправляет все запросы к API-шлюзам по протоколу HTTP на их HTTPS-версии. |                                                                                                                                     API Gateway поддерживает только одностороннюю проверку подлинности |
| поддержка различных форматов сообщений |                         Содержимое запроса — строка в формате JSON, обладает возможностями по настройке шаблонов обмена сообщениями                         | Apache Kafka использует бинарный формат для хранения и передачи сообщений. В сообщениях нет никакой информации об их структуре.   Т.е, само сообщение с точки зрения Kafka — просто набор байт, хранящийся в ячейке партиции под индексом с названием offset. Содержимое и структура не имеют значения для Kafka. |                                                                      Сообщение может содержать до 256 КБ текста в любом формате                                                                       |
| разделение прав доступа к различным потокам сообщений |                                                                разграничивает права доступа                                                                 |                                                                             не занимается контролем и распределением сообщений. Потребители сами опрашивают брокер и решают, какие сообщения им читать, брокер только хранит данные.                                                                              |            можно открыть общий доступ к очередям Amazon SQS как для анонимных, так и для конкретных аккаунтов AWS. Общий доступ к очередям можно ограничить по IP-адресам и времени суток.            |
| простота эксплуатации  |                                                       RabbitMQ более простой в установке и настройке                                                        |                                                                                                                                                 достаточно просто                                                                                                                                                 |             Если веб-приложение уже работает в инфраструктуре AWS, на настройку фактически не придется тратить время и сложностей будет существенно меньше, чем у множества других систем             |


Т.к. важны сохранность сообщений, высокая скорость работы, то выбор пал бы на Kafka.
